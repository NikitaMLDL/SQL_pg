# 1. Последовательность действий и обоснование

### Анализ требований
Сначала необходимо определить, какие метрики требуются по итогам выборки.

### Фильтрация исходных данных
В первую очередь следует отобрать записи из таблицы нарушений по заданному интервалу дат.

### Преобразование и группировка
Преобразование временной метки в дату необходимо для последующей группировки данных по дате.

### Объединение таблиц
Выполняется соединение таблиц нарушений и операций. Важно применять тип соединения **LEFT JOIN**, чтобы сохранить все записи из основной таблицы нарушений, даже если соответствующей операции не найдено.

### Агрегация данных
Агрегируем данные и находим нужные метрики.

Такая последовательность действий позволяет сначала сузить выборку до нужных данных и подготовить их для дальнейшей обработки, что повышает эффективность и снижает нагрузку на систему. Затем, после объединения таблиц, агрегация выполняется над уже чистыми и структурированными данными, что гарантирует корректный подсчёт всех требуемых метрик.

---

# 2. Различные подходы к построению запроса

### Вариант с прямым объединением (JOIN)
Этот подход предполагает одновременное соединение таблиц с помощью **LEFT JOIN** с включением условия на операционный код прямо в условии объединения. Это позволяет выполнить объединение таблиц в одном запросе, не используя CTE для предварительной обработки данных.

### Вариант с использованием CTE
Здесь сначала производится выборка и подготовка данных из основной таблицы с применением фильтра по дате и преобразованием временной метки в дату. Отдельно формируется набор уникальных идентификаторов нарушений для операций с заданным кодом. Далее два подготовленных набора объединяются для проведения агрегатных вычислений. Такой модульный подход позволяет:

- Разбить сложную логику на понятные части.
- Избежать проблем с дублированием данных, поскольку на этапе подготовки данных для операций сразу производится выборка уникальных значений.
- Упростить отладку и будущую модификацию запроса.

---

# 3. Рекомендация по выбору лучшего варианта

Оптимальным является вариант с использованием **CTE**.

### Причины выбора:

#### Модульность и структурированность
Разбиение запроса на отдельные логические блоки (один для выборки нарушений, другой – для получения операций с нужным кодом) делает запрос более понятным и легко модифицируемым.

#### Производительность
В запросах без CTE, например, при использовании JOIN, может возникнуть избыточность в данных (например, при многократном соединении таблиц с одной и той же логикой), что увеличивает нагрузку на базу данных. **CTE** позволяет избежать дублирования логики и обеспечивает более точное и оптимизированное выполнение запросов, так как промежуточные результаты уже предварительно фильтруются и агрегируются.

В итоге, хотя вариант с прямым JOIN может показаться более компактным, при более сложных условиях и больших объёмах данных использование **CTE** обеспечивает надежность, читаемость и легкость поддержки запроса.
